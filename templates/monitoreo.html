<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Charts - Kaiadmin Bootstrap 5 Admin Dashboard</title>
    <meta
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
      name="viewport"
    />
    <link
      rel="icon"
      href="{{ url_for('static', filename='/img/kaiadmin/favicon.ico')}}"
      type="image/x-icon"
    />

    <!-- Fonts and icons -->
    <script src="{{ url_for('static', filename='/js/plugin/webfont/webfont.min.js')}}"></script>
    <script>
      WebFont.load({
        google: { families: ["Public Sans:300,400,500,600,700"] },
        custom: {
          families: [
            "Font Awesome 5 Solid",
            "Font Awesome 5 Regular",
            "Font Awesome 5 Brands",
            "simple-line-icons",
          ],
          urls: ["{{ url_for('static', filename='/css/fonts.min.css')}}"],
        },
        active: function () {
          sessionStorage.fonts = true;
        },
      });
    </script>

    <!-- CSS Files -->
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/bootstrap.min.css')}}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/plugins.min.css')}}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/kaiadmin.min.css')}}" />

    <!-- CSS Just for demo purpose, don't include it in your project -->
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/demo.css')}}" />
  </head>
  <body>
    <div class="wrapper">
      <!-- Sidebar -->
      {% include 'menu.html' %}
      <!-- End Sidebar -->

      <div class="main-panel">
        {% include 'main-header.html' %}

        <div class="container">
          <div class="page-inner">
            <h3 class="fw-bold mb-3">Chart.js</h3>
            <div class="page-category">
              Simple yet flexible JavaScript charting for designers &
              developers. Please checkout their
              <a href="http://www.chartjs.org/" target="_blank">full documentation</a>.
            </div>
            <div>
              <canvas id="myChart"></canvas>
            </div>


          </div>
        </div>

        {% include'footer.html' %}
      </div>

      <!-- Custom template | don't include it in your project! -->
      {% include'settings.html' %}
      <!-- End Custom template -->
    </div>
    <!--   Core JS Files   -->
    <script src="{{ url_for('static', filename='/js/core/jquery-3.7.1.min.js')}}"></script>
    <script src="{{ url_for('static', filename='/js/core/popper.min.js')}}"></script>
    <script src="{{ url_for('static', filename='/js/core/bootstrap.min.js')}}"></script>
    <!-- Chart JS -->
    <script src="{{ url_for('static', filename='/js/plugin/chart.js/chart.min.js')}}"></script>
    <!-- jQuery Scrollbar -->
    <script src="{{ url_for('static', filename='/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js')}}"></script>
    <!-- Kaiadmin JS -->
    <script src="{{ url_for('static', filename='/js/kaiadmin.min.js')}}"></script>
    <!-- Kaiadmin DEMO methods, don't include it in your project! -->
    <script src="{{ url_for('static', filename='/js/setting-demo2.js')}}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const socket = io('http://localhost:3000', {
    transports: ['polling', 'websocket']
  });

  // Inicializar el gráfico
  const ctx = document.getElementById('myChart').getContext('2d');
  const myLineChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [], // Será llenado con las etiquetas (eje X)
      datasets: [{
        label: 'Lecturas del sensor',
        borderColor: '#1d7af3',
        backgroundColor: 'transparent',
        pointBorderColor: '#FFF',
        pointBackgroundColor: '#1d7af3',
        pointRadius: 4,
        fill: true,
        borderWidth: 2,
        data: []  // Será llenado con los datos (eje Y)
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'linear', // Asumimos que el eje X es numérico (tiempo, por ejemplo)
          position: 'bottom'
        },
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
        }
      }
    }
  });

  // Función para actualizar el gráfico con los nuevos datos
  function updateChart(data) {
    const { x, y } = data;

    myLineChart.data.labels = x;
    myLineChart.data.datasets[0].data = y;

    myLineChart.update();
  }

  // Manejo de errores de conexión
  socket.on('connect_error', (err) => {
    console.error('Error de conexión: ', err.message);
  });

  socket.on('connect_timeout', () => {
    console.error('Tiempo de conexión agotado');
  });

  socket.on('disconnect', () => {
    console.log('Desconectado del servidor');
  });

  // Escuchar los eventos 'new_data' que el servidor emite
  socket.on('new_data', function(data) {
    console.log('New data received: ', data);
    updateChart(data);  // Actualizar el gráfico con los datos recibidos
  });

  // Simulación de solicitud de datos cada 5 segundos
  setInterval(() => {
    try {
      socket.emit("get_data");  // Solicitar datos al servidor
    } catch (error) {
      console.error('Error al emitir la solicitud: ', error);
    }
  }, 5000); // Solicitar datos cada 5 segundos
</script>

</html>
